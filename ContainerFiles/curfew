FROM docker.io/library/ubuntu:24.04

LABEL summary="Curfew â€“ isolated development environment" \
      maintainer="david"

RUN export DEBIAN_FRONTEND=noninteractive \
    && apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y --no-install-recommends \
        # Wayland
        libwayland-client0 \
        libwayland-cursor0 \
        libwayland-egl1 \
        # GPU / Mesa
        mesa-utils \
        libgl1-mesa-dri \
        libglx-mesa0 \
        libegl-mesa0 \
        mesa-vulkan-drivers \
        libvulkan1 \
        # Clipboard (via Wayland)
        wl-clipboard \
        # Notifications (via D-Bus)
        libnotify-bin \
        # Core
        curl \
        wget \
        git \
        ca-certificates \
        bash \
        locales \
        xz-utils \
        gawk \
        gnupg \
        man-db \
        less \
        file \
        sudo \
        unzip \
        tar \
    && locale-gen en_US.UTF-8 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
ENV AGENT_BROWSER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
ENV DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus

# Third-party apt repos
COPY ../scripts/add-apt-repo.sh /usr/local/bin/add-apt-repo
RUN chmod +x /usr/local/bin/add-apt-repo \
    && add-apt-repo google-chrome \
        https://dl-ssl.google.com/linux/linux_signing_key.pub \
        http://dl.google.com/linux/chrome/deb/ stable main \
    && add-apt-repo pgdg \
        https://www.postgresql.org/media/keys/ACCC4CF8.asc \
        https://apt.postgresql.org/pub/repos/apt/ noble-pgdg main \
    && add-apt-repo nodesource \
        https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \
        https://deb.nodesource.com/node_22.x nodistro main \
    && apt-get update \
    && apt-get install -y \
        google-chrome-stable \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# CLI tools via ubi
RUN curl -sSf https://raw.githubusercontent.com/houseabsolute/ubi/master/bootstrap/bootstrap-ubi.sh | sh \
    && ubi --project sharkdp/bat --in /usr/local/bin \
    && ubi --project eza-community/eza --in /usr/local/bin \
    && ubi --project atuinsh/atuin --in /usr/local/bin \
    && ubi --project BurntSushi/ripgrep --exe rg --in /usr/local/bin \
    && ubi --project axllent/mailpit --in /usr/local/bin \
    && ubi --project F1bonacc1/process-compose --in /usr/local/bin \
    && ubi --project direnv/direnv --in /usr/local/bin \
    && ubi --project starship/starship --in /usr/local/bin \
    && ubi --project jesseduffield/lazygit --in /usr/local/bin \
    && ubi --project vercel-labs/agent-browser --in /usr/local/bin \
    && ubi --project steveyegge/beads --exe bd --in /usr/local/bin \
    && rm -f /usr/local/bin/ubi

# ble.sh
RUN curl -L https://github.com/akinomyoga/ble.sh/releases/download/nightly/ble-nightly.tar.xz \
    | tar xJf - -C /tmp \
    && bash /tmp/ble-nightly/ble.sh --install /usr/local/share/blesh \
    && rm -rf /tmp/ble-nightly

# Kitty terminfo
COPY ../terminfo/x/xterm-kitty /usr/share/terminfo/x/xterm-kitty

# Entrypoint (symlinks config files into ~app on each start)
COPY ../scripts/entrypoint.sh /usr/local/bin/entrypoint
RUN chmod +x /usr/local/bin/entrypoint

RUN userdel -r ubuntu \
    && groupadd -g 1000 app \
    && useradd -u 1000 -g 1000 -m -s /bin/bash app \
    && echo 'app ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/app

USER app
RUN curl -fsSL https://claude.ai/install.sh | bash
ENTRYPOINT ["entrypoint"]
CMD ["bash"]
