FROM docker.io/library/ubuntu:24.04

LABEL summary="Curfew â€“ isolated development environment" \
      maintainer="david"

RUN export DEBIAN_FRONTEND=noninteractive \
    && apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y --no-install-recommends \
        # Wayland
        libwayland-client0 \
        libwayland-cursor0 \
        libwayland-egl1 \
        # GPU / Mesa
        mesa-utils \
        libgl1-mesa-dri \
        libglx-mesa0 \
        libegl-mesa0 \
        mesa-vulkan-drivers \
        libvulkan1 \
        # Clipboard (via Wayland)
        wl-clipboard \
        # Core
        curl \
        wget \
        git \
        ca-certificates \
        bash \
        locales \
        xz-utils \
        gawk \
        gnupg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Third-party apt repos
COPY ../scripts/add-apt-repo.sh /usr/local/bin/add-apt-repo
RUN chmod +x /usr/local/bin/add-apt-repo \
    && add-apt-repo google-chrome \
        https://dl-ssl.google.com/linux/linux_signing_key.pub \
        http://dl.google.com/linux/chrome/deb/ stable main \
    && apt-get update \
    && apt-get install -y \
        google-chrome-stable \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# CLI tools via ubi
RUN curl -sSf https://raw.githubusercontent.com/houseabsolute/ubi/master/bootstrap/bootstrap-ubi.sh | sh \
    && ubi --project sharkdp/bat --in /usr/local/bin \
    && ubi --project eza-community/eza --in /usr/local/bin \
    && ubi --project atuinsh/atuin --in /usr/local/bin \
    && ubi --project BurntSushi/ripgrep --exe rg --in /usr/local/bin \
    && ubi --project axllent/mailpit --in /usr/local/bin \
    && ubi --project F1bonacc1/process-compose --in /usr/local/bin \
    && ubi --project direnv/direnv --in /usr/local/bin \
    && ubi --project starship/starship --in /usr/local/bin \
    && ubi --project vercel-labs/agent-browser --in /usr/local/bin \
    && ubi --project steveyegge/beads --exe bd --in /usr/local/bin \
    && rm -f /usr/local/bin/ubi

# ble.sh
RUN curl -L https://github.com/akinomyoga/ble.sh/releases/download/nightly/ble-nightly.tar.xz \
    | tar xJf - -C /tmp \
    && bash /tmp/ble-nightly/ble.sh --install /usr/local/share/blesh \
    && rm -rf /tmp/ble-nightly

RUN userdel -r ubuntu \
    && groupadd -g 1000 app \
    && useradd -u 1000 -g 1000 -m -s /bin/bash app \
    && mkdir -p /app \
    && chown app:app /app

USER app
WORKDIR /app
