#!/bin/bash
set -euo pipefail

IMAGE="ghcr.io/david/curfew:latest"
CONFIG_DIR="${CURFEW_CONFIG:-$HOME/.config/curfew}"
PROJECT_DIR="$(pwd)"
PARENT_NAME="$(basename "$(dirname "$PROJECT_DIR")" | tr '[:upper:]' '[:lower:]')"
PROJECT_NAME="$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')"
CONTAINER_NAME="curfew-${PARENT_NAME}-${PROJECT_NAME}"
LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/${CONTAINER_NAME}.lock"

start_container() {
    podman pull "$IMAGE" >/dev/null
    podman rm -f "$CONTAINER_NAME" &>/dev/null || true

    podman run -d 9>&- \
        --name "$CONTAINER_NAME" \
        --userns=keep-id:uid=1000,gid=1000 \
        -e TERM="$TERM" \
        -e WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
        -e XDG_RUNTIME_DIR=/run/user/1000 \
        \
        -v "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/run/user/1000/$WAYLAND_DISPLAY:ro" \
        -v "$XDG_RUNTIME_DIR/bus:/run/user/1000/bus" \
        --device /dev/dri \
        \
        -v "curfew-${PARENT_NAME}-app-home:/home/app" \
        -v "$CONFIG_DIR:/etc/curfew/config:ro,z" \
        -v "$PROJECT_DIR:/app:z" \
        \
        "$IMAGE" sleep infinity >/dev/null
}

ensure_running() {
    (
        flock -x 9
        if [ "$(podman inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null)" != "true" ]; then
            start_container
        fi
    ) 9>"$LOCK_FILE"
}

case "${1:-}" in
    restart)
        (
            flock -x 9
            start_container
        ) 9>"$LOCK_FILE"
        ;;
    run)
        shift
        ensure_running
        if [ $# -eq 0 ]; then
            set -- bash
        fi
        exec podman exec -it \
            -e TERM="$TERM" \
            -w /app \
            "$CONTAINER_NAME" \
            "$@"
        ;;
    gen)
        shift
        DOCKERFILE=".curfew.dockerfile"
        if [ -f "$DOCKERFILE" ]; then
            echo "$DOCKERFILE already exists" >&2
            exit 1
        fi

        installs=()
        while [ $# -gt 0 ]; do
            case "$1" in
                -i)
                    [ $# -ge 2 ] || { echo "Missing argument for -i" >&2; exit 1; }
                    installs+=("$2")
                    shift 2
                    ;;
                *)
                    echo "Unknown option: $1" >&2
                    exit 1
                    ;;
            esac
        done

        {
            echo "FROM ghcr.io/david/curfew:latest"
            echo ""
            echo "USER root"
            echo ""
            if [ ${#installs[@]} -gt 0 ]; then
                for spec in "${installs[@]}"; do
                    name="${spec%%:*}"
                    version="${spec#*:}"
                    if [ "$version" = "$spec" ]; then
                        echo "RUN /usr/local/installs/$name"
                    else
                        echo "RUN /usr/local/installs/$name $version"
                    fi
                done
            else
                echo "# Install project tools (available scripts: node, postgres, bun)"
                echo "# RUN /usr/local/installs/node 24"
                echo "# RUN /usr/local/installs/bun"
                echo "# RUN /usr/local/installs/postgres 17"
            fi
            echo ""
            echo "USER app"
        } > "$DOCKERFILE"

        echo "Created $DOCKERFILE"
        ;;
    *)
        echo "Usage: curfew <gen|restart|run> [cmd...]" >&2
        exit 1
        ;;
esac
