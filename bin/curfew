#!/bin/bash
set -euo pipefail

IMAGE="ghcr.io/david/curfew:latest"
CONFIG_DIR="${CURFEW_CONFIG:-$HOME/Dot/w0/config}"
PROJECT_DIR="$(pwd)"
PARENT_NAME="$(basename "$(dirname "$PROJECT_DIR")" | tr '[:upper:]' '[:lower:]')"
PROJECT_NAME="$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')"
CONTAINER_NAME="curfew-${PARENT_NAME}-${PROJECT_NAME}"
LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/${CONTAINER_NAME}.lock"

start_container() {
    podman pull "$IMAGE" >/dev/null
    podman rm -f "$CONTAINER_NAME" &>/dev/null || true

    podman run -d 9>&- \
        --name "$CONTAINER_NAME" \
        --userns=keep-id:uid=1000,gid=1000 \
        -e TERM="$TERM" \
        -e WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
        -e XDG_RUNTIME_DIR=/run/user/1000 \
        \
        -v "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/run/user/1000/$WAYLAND_DISPLAY:ro" \
        -v "$XDG_RUNTIME_DIR/bus:/run/user/1000/bus" \
        --device /dev/dri \
        \
        -v "curfew-${PARENT_NAME}-app-home:/home/app" \
        -v "$CONFIG_DIR:/etc/curfew/config:ro,z" \
        -v "$PROJECT_DIR:$PROJECT_DIR:z" \
        \
        "$IMAGE" sleep infinity >/dev/null
}

ensure_running() {
    (
        flock -x 9
        if [ "$(podman inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null)" != "true" ]; then
            start_container
        fi
    ) 9>"$LOCK_FILE"
}

case "${1:-}" in
    restart)
        (
            flock -x 9
            start_container
        ) 9>"$LOCK_FILE"
        ;;
    setup)
        ensure_running
        exec podman exec -it \
            -e TERM="$TERM" \
            "$CONTAINER_NAME" \
            /usr/local/setup/gh-auth
        ;;
    run)
        shift
        ensure_running
        if [ $# -eq 0 ]; then
            set -- bash
        fi
        exec podman exec -it \
            -e TERM="$TERM" \
            -w "$PROJECT_DIR" \
            "$CONTAINER_NAME" \
            "$@"
        ;;
    *)
        echo "Usage: curfew <restart|setup|run> [cmd...]" >&2
        exit 1
        ;;
esac
