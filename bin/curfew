#!/bin/bash
set -euo pipefail

BASE_IMAGE="ghcr.io/david/curfew:latest"
CONFIG_DIR="${CURFEW_CONFIG:-$HOME/.config/curfew}"
TREE_DIR="$(pwd)"
PROJECT_NAME="$(basename "$(dirname "$TREE_DIR")" | tr '[:upper:]' '[:lower:]')"
TREE_NAME="$(basename "$TREE_DIR" | tr '[:upper:]' '[:lower:]')"
CONTAINER_NAME="curfew-${PROJECT_NAME}-${TREE_NAME}"
LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/${CONTAINER_NAME}.lock"

resolve_image() {
    local local_image="localhost/${PROJECT_NAME}"
    if podman image exists "$local_image" 2>/dev/null; then
        echo "$local_image"
    else
        echo "$BASE_IMAGE"
    fi
}

start_container() {
    local image
    image="$(resolve_image)"

    if [ "$image" = "$BASE_IMAGE" ]; then
        echo "Pulling $image..." >&2
        podman pull "$image"
    fi

    echo "Starting $CONTAINER_NAME ($image)..." >&2
    podman rm -f "$CONTAINER_NAME" &>/dev/null || true

    podman run -d 9>&- \
        --name "$CONTAINER_NAME" \
        --userns=keep-id:uid=1000,gid=1000 \
        -e TERM="$TERM" \
        -e WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
        -e XDG_RUNTIME_DIR=/run/user/1000 \
        \
        -v "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/run/user/1000/$WAYLAND_DISPLAY:ro" \
        -v "$XDG_RUNTIME_DIR/bus:/run/user/1000/bus" \
        --device /dev/dri \
        \
        -v "curfew-${PROJECT_NAME}-app-home:/home/app" \
        -v "$CONFIG_DIR:/etc/curfew/config:ro,z" \
        -v "$TREE_DIR:/app:z" \
        \
        "$image" sleep infinity >/dev/null
}

ensure_running() {
    (
        flock -x 9
        if [ "$(podman inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null)" != "true" ]; then
            start_container
        fi
    ) 9>"$LOCK_FILE"
}

case "${1:-}" in
    restart)
        (
            flock -x 9
            start_container
        ) 9>"$LOCK_FILE"
        ;;
    run)
        shift
        ensure_running
        if [ $# -eq 0 ]; then
            set -- bash
        fi
        tty_flags="-i"
        if [ -t 0 ] && [ -t 1 ]; then
            tty_flags="-it"
        fi
        exec podman exec $tty_flags \
            -e TERM="$TERM" \
            -w /app \
            "$CONTAINER_NAME" \
            "$@"
        ;;
    build)
        if [ ! -f ".curfew.dockerfile" ]; then
            echo "No .curfew.dockerfile found (use 'curfew gen' to create one)" >&2
            exit 1
        fi
        podman build --pull=always -t "localhost/${PROJECT_NAME}" -f .curfew.dockerfile .
        ;;
    gen)
        shift
        DOCKERFILE=".curfew.dockerfile"
        if [ -f "$DOCKERFILE" ]; then
            echo "$DOCKERFILE already exists" >&2
            exit 1
        fi

        installs=()
        while [ $# -gt 0 ]; do
            case "$1" in
                -i)
                    [ $# -ge 2 ] || { echo "Missing argument for -i" >&2; exit 1; }
                    installs+=("$2")
                    shift 2
                    ;;
                *)
                    echo "Unknown option: $1" >&2
                    exit 1
                    ;;
            esac
        done

        {
            echo "FROM ghcr.io/david/curfew:latest"
            echo ""
            echo "USER root"
            echo ""
            if [ ${#installs[@]} -gt 0 ]; then
                for spec in "${installs[@]}"; do
                    name="${spec%%:*}"
                    version="${spec#*:}"
                    if [ "$version" = "$spec" ]; then
                        echo "RUN /usr/local/installs/$name"
                    else
                        echo "RUN /usr/local/installs/$name $version"
                    fi
                done
            else
                echo "# Install project tools (available scripts: node, postgres, bun)"
                echo "# RUN /usr/local/installs/node 24"
                echo "# RUN /usr/local/installs/bun"
                echo "# RUN /usr/local/installs/postgres 17"
            fi
            echo ""
            echo "USER app"
        } > "$DOCKERFILE"

        echo "Created $DOCKERFILE"
        ;;
    *)
        echo "Usage: curfew <build|gen|restart|run> [cmd...]" >&2
        exit 1
        ;;
esac
