#!/bin/bash
set -euo pipefail

IMAGE="ghcr.io/david/curfew:latest"
CONFIG_DIR="${CURFEW_CONFIG:-$HOME/Dot/w0/config}"
PROJECT_DIR="${1:-$(pwd)}"
PROJECT_NAME="$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')"

exec podman run --rm -it \
    -e TERM="$TERM" \
    -e WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
    -e XDG_RUNTIME_DIR=/run/user/1000 \
    \
    -v "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/run/user/1000/$WAYLAND_DISPLAY:ro" \
    -v "$XDG_RUNTIME_DIR/bus:/run/user/1000/bus" \
    --device /dev/dri \
    \
    -v "${PROJECT_NAME}-app-home:/home/app" \
    -v "$CONFIG_DIR:/etc/curfew/config:ro" \
    -v "$PROJECT_DIR:$PROJECT_DIR" \
    --workdir "$PROJECT_DIR" \
    \
    "$IMAGE"
